<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DecenSocial - Profile</title>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="navbar">
        <a href="index.html">Home</a>
        <a href="profile.html">Profile</a>
        <a href="settings.html">Settings</a>
        <button class="btn" onclick="localStorage.removeItem('ourTokenId'); window.location.href = 'login.html';" style="float: right;">Logout</button>    
    </div>


    <div class="container">
        <h1 id="profile-text">Profile</h1>
        <br>
        <h2 id="username">Loading...</h2>

        <div class="stats">
            <strong id="followers-text">Followers:</strong> <span id="followers-count">Loading...</span>
            <span>|</span>
            <strong id="following-text">Following:</strong> <span id="following-count">Loading...</span>
        </div>

        <button id="follow-btn" class="btn">Follow</button>

        <button id="report-btn" class="btn"">Report Profile</button>

        <br>
        <!-- Display Follow Fee -->
        <div id="follow-fee-section">
            <strong id="follow-fee-text">Following Fee:</strong> <span id="follow-fee">Loading...</span>
        </div>

            <!-- Input for setting the follow fee -->
        <div id="set-follow-fee-section">
            <label for="set-follow-fee">Set Follow Fee:</label>
            <input type="number" id="set-follow-fee" placeholder="Set new follow fee" min="0" />
            <button id="set-follow-fee-btn">Set Fee</button>
        </div>



        <div class="posts" id="posts-section">
            <h3>Posts:</h3>
            <div id="posts-container">Loading...</div>
        </div>

    </div>

    <div class="overlay" id="overlay"></div>
    <div class="popup" id="popup">
        <h3 id="popup-title"></h3>
        <ul id="popup-list"></ul>
        <button class="popup-close" onclick="closePopup()">Close</button>
    </div>

    <script>
        let web3;
        let account;
        let ourTokenId;
        let urlTokenId;
        let ourFollowings = [];
        const contracts = {
            DecenSocialAccount: {
                address: null,
                abi: null
            },
            FollowManager: {
                address: null,
                abi: null
            },
            PostManager: {
                address: null,
                abi: null
            },
            ReportManager: {
                address: null,
                abi: null
            }
        };

        async function loadContracts() {
            for (const [key, contract] of Object.entries(contracts)) {
                const abiResponse = await fetch(`ABIs/${key}.txt`);
                contract.abi = JSON.parse(await abiResponse.text());
                const addressResponse = await fetch(`hashes/${key}.txt`);
                contract.address = (await addressResponse.text()).trim();
            }
        }

        async function initialize() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                account = (await web3.eth.getAccounts())[0];

                await loadContracts();

                for (const contract of Object.values(contracts)) {
                    contract.instance = new web3.eth.Contract(contract.abi, contract.address);
                }

                ourTokenId = localStorage.getItem("ourTokenId");

                if(!ourTokenId) {
                    alert("Please login first!");
                    window.location.href = "login.html";
                }

                const urlParams = new URLSearchParams(window.location.search);
                urlTokenId = urlParams.get('tokenID')



                if (urlTokenId) {
                    urlTokenId = parseInt(urlTokenId);
                    await loadProfile(urlTokenId);
                } else {
                    ourTokenId = parseInt(ourTokenId);
                    document.getElementById('profile-text').textContent = 'My Profile';
                    await loadProfile(ourTokenId);
                }
            } else {
                alert("Please install MetaMask!");
            }
        }

        async function loadProfile(tokenId) {
            const accountContract = contracts.DecenSocialAccount.instance;
            const followManager = contracts.FollowManager.instance;
            const postManager = contracts.PostManager.instance;

            const username = await accountContract.methods.getUsername(tokenId).call();

            try {
                const isVerified = await accountContract.methods.getVerifiedName(tokenId).call();
                document.getElementById('username').innerHTML = `${username} (Verified)`;

            } catch (error) {
                document.getElementById('username').textContent = username;

            }


        

            const followers = await followManager.methods.getFollowersOfUser(tokenId).call();
            const followings = await followManager.methods.getFollowingsOfUser(tokenId).call();
            ourFollowings = await contracts.FollowManager.instance.methods.getFollowingsOfUser(ourTokenId).call();


            document.getElementById('followers-count').textContent = followers.length;
            document.getElementById('followers-text').onclick = () => openPopup('Followers', followers);

            document.getElementById('following-count').textContent = followings.length;
            document.getElementById('following-text').onclick = () => openPopup('Following', followings);

            // Change text of follow button based on whether the user is already following the profile
            const followBtn = document.getElementById('follow-btn');
            const reportBtn = document.getElementById('report-btn');


            
            if (tokenId == ourTokenId) { // If the profile is our own, hide the follow and report button
                followBtn.style.display = 'none';
                reportBtn.style.display = 'none';
                await loadFollowFee();
            } else {
                document.getElementById('follow-fee-section').style.display = 'none';
                document.getElementById('set-follow-fee-section').style.display = 'none';
                console.log("güncelle")
                if (ourFollowings.includes(BigInt(tokenId))) {
                    console.log("güncelle2")
                    followBtn.textContent = 'Unfollow';
                    followBtn.onclick = () => unfollowUser(tokenId);
                } else {
                    console.log("güncelle3")
                    followBtn.textContent = 'Follow';
                    followBtn.onclick = () => followUser(tokenId);
                }
            }

            reportBtn.onclick = () => reportProfile(tokenId);

            await loadPosts(postManager, tokenId);
        }

        async function loadPosts(postManager, tokenId) {
            const postsContainer = document.getElementById('posts-container');
            postsContainer.innerHTML = "";

            const posts = await postManager.methods.getPostsOfUser(tokenId).call();
            if (posts.length === 0) {
                postsContainer.textContent = "No posts available.";
                return;
            }

            posts.sort((a, b) => Number(b.timestamp) - Number(a.timestamp));

            posts.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post-item';

                const timestamp = new Date(Number(post.timestamp) * 1000).toLocaleString();
                const contentDiv = document.createElement('div');
                contentDiv.className = 'post-content';
                contentDiv.textContent = post.content;

                const postInfoDiv = document.createElement('div');
                postInfoDiv.className = 'post-info';
                postInfoDiv.innerHTML = `<strong>Post ID:</strong> ${post.postId}<br><strong>Posted on:</strong> ${timestamp}`;

                postDiv.appendChild(postInfoDiv);
                postDiv.appendChild(contentDiv);
                postsContainer.appendChild(postDiv);
            });
        }

        function openPopup(title, list) {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            const popupList = document.getElementById('popup-list');

            document.getElementById('popup-title').textContent = title;
            popupList.innerHTML = '';

            list.forEach(async (id) => {
                const username = await contracts.DecenSocialAccount.instance.methods.getUsername(id).call();
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `?tokenID=${id}`;
                a.textContent = username;
                li.appendChild(a);
                popupList.appendChild(li);
            });

            popup.style.display = 'block';
            overlay.style.display = 'block';
        }

        function closePopup() {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        window.addEventListener('load', initialize);


        async function followUser(tokenId) {
            const followManager = contracts.FollowManager.instance;
            await followManager.methods.follow(ourTokenId, tokenId).send({ from: account });
            loadProfile(tokenId);
        }

        async function unfollowUser(tokenId) {
            const followManager = contracts.FollowManager.instance;
            await followManager.methods.unfollow(ourTokenId, tokenId).send({ from: account });
            loadProfile(tokenId);
        }

        async function reportProfile(tokenId) {
            const reportManager = contracts.ReportManager.instance;
            await reportManager.methods.reportUser(ourTokenId, tokenId).send({ from: account });
            alert("Profile reported successfully!");
        }

        // Fetch current follow fee and display it
async function loadFollowFee() {
    const accountContract = contracts.DecenSocialAccount.instance
    const followFee = await accountContract.methods.getFollowFee(ourTokenId).call();
    document.getElementById("follow-fee").textContent = web3.utils.fromWei(followFee, "ether");
}

// Update the follow fee
document.getElementById("set-follow-fee-btn").addEventListener("click", async () => {
    const newFollowFee = document.getElementById("set-follow-fee").value;

    if (!newFollowFee || newFollowFee <= 0) {
        alert("Please enter a valid follow fee.");
        return;
    }

    const accountContract = contracts.DecenSocialAccount.instance;
    try {
        await accountContract.methods.setFollowFee(ourTokenId, web3.utils.toWei((newFollowFee), "ether")).send({ from: account });
        alert("Follow fee updated successfully!");
        loadFollowFee(); // Refresh the follow fee after setting it
    } catch (error) {
        console.error("Error setting follow fee", error);
        alert("Failed to update follow fee.");
    }
});




    </script>
</body>
</html>
