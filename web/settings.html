<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DecenSocial - Settings</title>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="navbar">
        <a href="index.html">Home</a>
        <a href="profile.html">Profile</a>
        <a href="settings.html">Settings</a>
        <button class="btn" onclick="localStorage.removeItem('ourTokenId'); window.location.href = 'login.html';" style="float: right;">Logout</button>    
    </div>


    <div class="container">
        <h1 id="settings-text">Settings</h1>
        <br>

        <!-- Display Follow Fee -->
        <div id="follow-fee-section">
            <strong id="follow-fee-text">Following Fee:</strong> <span id="follow-fee">Loading...</span>
        </div>

        <br>
            <!-- Input for setting the follow fee -->
        <div id="set-follow-fee-section">
            <label for="set-follow-fee">Set Follow Fee:</label>
            <input type="number" id="set-follow-fee" placeholder="in wei" min="0" />
            <button id="set-follow-fee-btn">Set Fee</button>
        </div>

        <br>
        <br>

        <div id="token-balance-section">
            <strong id="token-balance-text">Token Balance:</strong> <span id="token-balance">Loading...</span>
        </div>

       <br>

        <div id="buy-token-section">
            <label for="buy-token">Buy Token(1 DST = 50 wei):</label>
            <input type="number" id="buy-token" placeholder="in wei" min="0" />
            <button id="buy-token-btn">Buy</button>
        </div>

        <br>
        <br>

        <div id="verify-section">
            <label for="verify">Verify Account (50 DST):</label>
            <input type="text" id="verify" placeholder="Enter your full name" />
            <button id="verify-btn">Verify</button>
        </div>


    </div>


    <script>
        let web3;
        let account;
        let ourTokenId;
        let urlTokenId;
        let ourFollowings = [];
        const contracts = {
            DecenSocialAccount: {
                address: null,
                abi: null
            },
            FollowManager: {
                address: null,
                abi: null
            },
            PostManager: {
                address: null,
                abi: null
            },
            ReportManager: {
                address: null,
                abi: null
            },
            DecenSocialToken: {
                address: null,
                abi: null
            }
        };

        async function loadContracts() {
            for (const [key, contract] of Object.entries(contracts)) {
                const abiResponse = await fetch(`ABIs/${key}.txt`);
                contract.abi = JSON.parse(await abiResponse.text());
                const addressResponse = await fetch(`hashes/${key}.txt`);
                contract.address = (await addressResponse.text()).trim();
            }
        }

        async function initialize() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                account = (await web3.eth.getAccounts())[0];

                await loadContracts();

                for (const contract of Object.values(contracts)) {
                    contract.instance = new web3.eth.Contract(contract.abi, contract.address);
                }

                ourTokenId = localStorage.getItem("ourTokenId");

                if(!ourTokenId) {
                    alert("Please login first!");
                    window.location.href = "login.html";
                }

                const urlParams = new URLSearchParams(window.location.search);
                urlTokenId = urlParams.get('tokenID')


                FollowManager = contracts.FollowManager.instance;
                AccountContract = contracts.DecenSocialAccount.instance;
                PostManager = contracts.PostManager.instance;


                listenToPostCreatedEvent(PostManager, AccountContract, FollowManager);
                
                await loadTokenBalance();
                await loadFollowFee();


               
            } else {
                alert("Please install MetaMask!");
            }
        }

      
       
        window.addEventListener('load', initialize);



        // Fetch current follow fee and display it
async function loadFollowFee() {
    const accountContract = contracts.DecenSocialAccount.instance
    const followFee = await accountContract.methods.getFollowFee(ourTokenId).call();
    document.getElementById("follow-fee").textContent = followFee + " DST";
}

// Update the follow fee
document.getElementById("set-follow-fee-btn").addEventListener("click", async () => {
    const newFollowFee = document.getElementById("set-follow-fee").value;

    if (!newFollowFee || newFollowFee <= 0) {
        alert("Please enter a valid follow fee.");
        return;
    }

    const accountContract = contracts.DecenSocialAccount.instance;
    try {
        await accountContract.methods.setFollowFee(ourTokenId, newFollowFee).send({ from: account });
        alert("Follow fee updated successfully!");
        loadFollowFee(); // Refresh the follow fee after setting it
    } catch (error) {
        console.error("Error setting follow fee", error);
        alert("Failed to update follow fee.");
    }
});


    document.getElementById("buy-token-btn").addEventListener("click", buyToken);


    async function buyToken() {
        console.log("amount", document.getElementById("buy-token").value);
        const amount = document.getElementById("buy-token").value;
        if (!amount || amount <= 0) {
            alert("Please enter a valid amount.");
            return;
        }

        const tokenContract = contracts.DecenSocialToken.instance;
        try {
            await tokenContract.methods.buyTokens().send({ from: account, value: amount });
            alert("Token purchased successfully!");
        } catch (error) {
            console.error("Error buying token", error);
            alert("Failed to buy token.");
        }
        
    }


    async function loadTokenBalance() {
        const tokenContract = contracts.DecenSocialToken.instance;
        const balance = await tokenContract.methods.balanceOf(account).call();
        document.getElementById("token-balance").textContent = balance + " DST";
        
    }

    document.getElementById("verify-btn").addEventListener("click", verifyAccount);


  async function verifyAccount() {
    const name = document.getElementById("verify").value;
    if (!name) {
        alert("Please enter your full name.");
        return;
    }

    const accountContract = contracts.DecenSocialAccount.instance;
    const tokenContract = contracts.DecenSocialToken.instance;

    const verificationFee = web3.utils.toWei("1", "ether"); // Replace with the correct fee amount

    try {
        // Step 1: Check current allowance
        const allowance = await tokenContract.methods.allowance(account, contracts.DecenSocialAccount.address).call();

        // Step 2: Approve if allowance is insufficient
        if (BigInt(allowance) < BigInt(verificationFee)) {
            await tokenContract.methods.approve(contracts.DecenSocialAccount.address, verificationFee).send({ from: account });
            alert("Approval successful! Proceeding with verification.");
        }

        // Step 3: Call the verifyAccount method
        await accountContract.methods.verifyAccount(ourTokenId, name).send({ from: account });
        alert("Account verified successfully!");
    } catch (error) {
        console.error("Error verifying account", error);
        alert("Failed to verify account. Please try again.");
    }
}
   





function listenToPostCreatedEvent(postManager, accountContract, followmanager) {
    if (!postManager || !postManager.events) {
        console.error("Invalid contract instance or missing events property");
        return;
    }
    console.log("Listening to PostCreated event...");

    postManager.events.PostCreated({
        fromBlock: 'latest'
    })
    .on('data', async event => {

        isFollowing = await followmanager.methods.isFollowingUser(ourTokenId, event.returnValues.accountId).call();

        if (isFollowing) {
            authorName = await accountContract.methods.getUsername(event.returnValues.accountId).call()
            alert("New post created from user " + authorName); 
        }

    })
}






    </script>
</body>
</html>
